<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Meu Dashboard Seguro</title>
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.0.0/dist/quicksight-embedding-js-sdk.min.js"></script>
    <style>
        #dashboardContainer { width: 100%; height: 800px; display: none; }
        #loading { text-align: center; margin-top: 50px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Verificando autenticação...</div>
    <div id="dashboardContainer"></div>

    <script>
        // CONFIGURAÇÕES DO COGNITO (Pegue dos outputs do Terraform)
        const LOGIN_URL = "https://vpaulo-dashboard-auth.auth.us-east-1.amazoncognito.com/login?client_id=6linms5mcuo1ha6pl3pe4tgjp0&response_type=token&scope=email+openid+profile&redirect_uri=https://d29go85x01tws8.cloudfront.net/index.html"; 

        function getTokensFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get("id_token");
        }

        async function init() {
            const idToken = getTokensFromUrl();

            if (!idToken) {
                // Se não está logado, vai para a página da AWS
                window.location.href = LOGIN_URL;
                return;
            }

            // Se chegou aqui, está logado!
            document.getElementById("loading").style.display = "none";
            document.getElementById("dashboardContainer").style.display = "block";
            
            // Chama a função de embed (que já criamos antes)
            embedDashboard();
        }

        async function embedDashboard() {
            try {
                // No futuro (Fase 2), passaremos o idToken no header para a API
                const response = await fetch('https://SUA-API.execute-api.region.amazonaws.com/get-url');
                const data = await response.json();
                
                const containerDiv = document.getElementById("dashboardContainer");
                const options = {
                    url: data.embedUrl,
                    container: containerDiv,
                    height: "100%",
                    width: "100%",
                    locale: "pt-BR"
                };
                
                const embeddingContext = await QuickSightEmbedding.createEmbeddingContext();
                await embeddingContext.embedDashboard(options);
            } catch (err) {
                console.error("Erro no embed:", err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>