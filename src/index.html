<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Meu Dashboard Seguro</title>
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.0.0/dist/quicksight-embedding-js-sdk.min.js"></script>
    <style>
        #dashboardContainer { width: 100%; height: 800px; display: none; }
        #loading { text-align: center; margin-top: 50px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Verificando autenticação...</div>
    <div id="dashboardContainer"></div>

    <script>
        const LOGIN_URL = "https://vpaulo-dashboard-auth.auth.us-east-1.amazoncognito.com/login?client_id=6linms5mcuo1ha6pl3pe4tgjp0&response_type=token&scope=email+openid+profile&redirect_uri=https://dash.vpaulo.com/index.html";

        function getTokensFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get("id_token");
        }

        async function init() {
            const idToken = getTokensFromUrl();

            if (!idToken) {
                window.location.href = LOGIN_URL;
                return;
            }

            document.getElementById("loading").style.display = "none";
            document.getElementById("dashboardContainer").style.display = "block";
            
            embedDashboard();
        }

        async function embedDashboard() {
            try {
                const idToken = getTokensFromUrl();

                // URL da sua API GATEWAY
                const response = await fetch('https://l8zcau79cb.execute-api.us-east-1.amazonaws.com/get-url', {
                    method: 'GET',
                    headers: {
                        'Authorization': idToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    console.error("Usuário não autorizado!");
                    window.location.href = LOGIN_URL;
                    return;
                }

                const data = await response.json();

                // Definindo as opções de renderização
                const containerDiv = document.getElementById("dashboardContainer");
                const options = {
                    url: data.embedUrl, // URL que vem da Lambda
                    container: containerDiv,
                    height: "100%",
                    width: "100%",
                    locale: "pt-BR"
                };

                const embeddingContext = await QuickSightEmbedding.createEmbeddingContext();
                await embeddingContext.embedDashboard(options);

            } catch (err) {
                console.error("Erro no embed:", err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>