<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Portal de Analytics</title>
    <!-- SDK de embedding do QuickSight -->
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.0.0/dist/quicksight-embedding-js-sdk.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        h1 { margin: 0; color: #333; }
        .btn-logout { 
            padding: 10px 20px; 
            background-color: #d9534f; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .btn-logout:hover { background-color: #c9302c; }
        #dashboardContainer { width: 100%; height: 800px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #loading { text-align: center; margin-top: 50px; }
    </style>
</head>
<body>

    <div id="loading">Verificando autenticação...</div>

    <div id="mainContent" style="display: none;">
        <div class="header">
            <h1>Relatório Executivo de Vendas</h1>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
        <div id="dashboardContainer"></div>
    </div>

    <script>
        // Substitua esta URL pelo output do Terraform para o Cognito Login
        const LOGIN_URL = "https://name.auth.us-east-1.amazoncognito.com/login?client_id=xxxx&response_type=token&scope=email+openid+profile&redirect_uri=https://url_callback/index.html";
        const API_URL = "https://SUA-API-ID.execute-api.region.amazonaws.com/get-url";

        function getTokensFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get("id_token");
        }

                // criar no deploy
        // const CLIENT_ID = "SEU_COGNITO_CLIENT_ID_AQUI"; 
        // const COGNITO_DOMAIN = "xxxxxxxxxxxxxxxxxx-auth.auth.us-east-1.amazoncognito.com";
        // const LOGOUT_REDIRECT_URL = "https://domain.com/index.html";

        function logout() {
            // 1. Limpa o token do estado atual da página
            window.location.hash = "";
            
            // 2. Constrói a URL de Logout definitivo do Cognito
            const logoutUrl = `https://name.auth.us-east-1.amazoncognito.com/logout?client_id=xxxx&logout_uri=https://url_callback/index.html`;
            
            // 3. Redireciona o navegador para a AWS fazer o logoff
            window.location.href = logoutUrl;
        }

        async function init() {
            const idToken = getTokensFromUrl();

            if (!idToken) {
                window.location.href = LOGIN_URL;
                return;
            }

            document.getElementById("loading").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            
            embedDashboard();
        }

        async function embedDashboard() {
            try {
                const idToken = getTokensFromUrl();

                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': idToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }

                const data = await response.json();

                const containerDiv = document.getElementById("dashboardContainer");
                const options = {
                    url: data.embedUrl,
                    container: containerDiv,
                    height: "100%",
                    width: "100%",
                    locale: "pt-BR"
                };

                const embeddingContext = await QuickSightEmbedding.createEmbeddingContext();
                await embeddingContext.embedDashboard(options);

            } catch (err) {
                console.error("Erro no embed:", err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>