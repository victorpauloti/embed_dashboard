<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Meu Dashboard Seguro</title>
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.0.0/dist/quicksight-embedding-js-sdk.min.js"></script>
    <style>
        #dashboardContainer { width: 100%; height: 800px; display: none; }
        #loading { text-align: center; margin-top: 50px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Verificando autenticação...</div>
    <div id="dashboardContainer"></div>

    <script>
        // CONFIGURAÇÕES DO COGNITO (Pegue dos outputs do Terraform)
        const LOGIN_URL = "SUA_COGNITO_LOGIN_URL_AQUI";

        function getTokensFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get("id_token");
        }

        async function init() {
            const idToken = getTokensFromUrl();

            if (!idToken) {
                // Se não está logado, vai para a página da AWS
                window.location.href = LOGIN_URL;
                return;
            }

            // Se chegou aqui, está logado!
            document.getElementById("loading").style.display = "none";
            document.getElementById("dashboardContainer").style.display = "block";
            
            // Chama a função de embed (que já criamos antes)
            embedDashboard();
        }

        async function embedDashboard() {
            try {
                const idToken = getTokensFromUrl(); // Função que já criamos

                const response = await fetch('https://SUA-API.execute-api.region.amazonaws.com/get-url', {
                    method: 'GET',
                    headers: {
                        'Authorization': idToken, // O token vai aqui
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    console.error("Usuário não autorizado!");
                    window.location.href = LOGIN_URL; // Redireciona se o token expirou
                    return;
                }

                const data = await response.json();

                const embeddingContext = await QuickSightEmbedding.createEmbeddingContext();
                await embeddingContext.embedDashboard(options);

            } catch (err) {
                console.error("Erro no embed:", err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>